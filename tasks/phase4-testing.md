# Phase 4: 测试与优化

## 目标
完整测试、错误处理优化、UI 美化、文档编写。

## 测试清单

### 1. 单元测试 - 卡密状态机
文件: `src/lib/__tests__/cardkey.test.ts`

测试用例：
- [ ] 生成卡密格式正确（16位随机码）
- [ ] 锁定卡密成功（UNUSED → LOCKED）
- [ ] 锁定已锁定卡密失败
- [ ] 消耗卡密成功（LOCKED → CONSUMED）
- [ ] 消耗未锁定卡密失败
- [ ] 解锁卡密成功（LOCKED → UNUSED）
- [ ] 作废卡密成功
- [ ] 过期卡密无法使用

### 2. 单元测试 - verificationId 校验
文件: `src/lib/__tests__/validation.test.ts`

测试用例：
- [ ] 有效 ID 返回 null
- [ ] 长度不足 24 位返回错误
- [ ] 非十六进制字符返回错误
- [ ] 前缀非 69/6a 返回错误
- [ ] 从 URL 正确提取 ID
- [ ] 从路径正确提取 ID

### 3. 集成测试 - API
文件: `src/app/api/__tests__/`

测试用例：
- [ ] POST /api/verify 参数校验
- [ ] POST /api/query 返回正确历史
- [ ] GET /api/stats 返回今日统计
- [ ] 管理员 API 权限验证

### 4. 端到端测试 - 用户流程
使用浏览器测试：
1. 打开 http://localhost:3000
2. 输入测试 SheerID 链接
3. 输入测试卡密
4. 点击提交
5. 观察进度更新
6. 验证结果正确显示
7. 验证卡密状态变更

### 5. 端到端测试 - 管理员流程
1. 打开 http://localhost:3000/admin
2. 输入密码登录
3. 生成 10 个卡密
4. 搜索卡密
5. 作废一个卡密
6. 导出 CSV

## 错误处理优化

### 用户友好错误消息
| 错误类型 | 技术信息 | 用户提示 |
|---------|---------|---------|
| 网络错误 | fetch failed | 网络连接失败，请检查网络后重试 |
| 超时 | timeout | 验证超时，请稍后重试 |
| 卡密无效 | key not found | 卡密不存在或已失效 |
| 卡密已使用 | key consumed | 该卡密已被使用 |
| 链接已激活 | right click error | 请右键复制链接，不要点击进入后再复制 |
| 链接已验证 | already completed | 该链接已验证过 |

### 边界情况处理
- [ ] SSE 连接中断自动重连
- [ ] 页面刷新保留进度（可选）
- [ ] 并发提交去重
- [ ] 超长链接截断显示

## UI/UX 优化

### 动画
- [ ] 按钮 hover 效果
- [ ] 加载 spinner
- [ ] 成功/失败状态动画
- [ ] 卡片 fade in

### 响应式
- [ ] 移动端适配
- [ ] 触屏友好（大按钮、大输入框）

### 可访问性
- [ ] 键盘导航
- [ ] 颜色对比度
- [ ] 加载状态 aria-label

## 文档

### README.md
- [ ] 项目介绍
- [ ] 快速开始
- [ ] 环境变量说明
- [ ] 开发命令
- [ ] 部署说明

### CHANGELOG.md
- [ ] 版本记录

## 验收标准
- [ ] 所有测试通过
- [ ] `npm run build` 无警告
- [ ] Lighthouse 性能 > 80
- [ ] 移动端布局正常
- [ ] README 完整
